# Restaurant Depot layout rules
# Multiple layouts that apply based on file extension, header text, or content
rd_layouts:
  # Variant A: Require Item Description + Extended Amount (USD), with qty/unit optional
  - name: "RD Excel v_qty_unit_total"
    parsed_by: "rd_excel_v1"
    applies_to:
      vendor_code: ["RD", "RESTAURANT_DEPOT"]
      file_ext: [".xlsx", ".xls"]
      header_contains:
        - "Item Description"
        - "(?i)Extended\\s*Amount(?:\\s*\\(USD\\))?"
    required_columns:
      - "Item Description"
      - "Extended Amount (USD)"
    optional_columns:
      - "QTY"
      - "Unit Price"
      - "Item Number"
      - "UPC"
      - "Transaction Date"
    column_mappings:
      product_name: "Item Description"
      quantity: "^(QTY|Qty|Quantity)$"
      unit_price: "^(Unit\\s*Price|Price|UnitPrice)$"
      total_price: "(?i)Extended\\s*Amount(?:\\s*\\(USD\\))?|Total\\s*Price"
      item_number: "^(Item\\s*Number|Item\\s*#|Item\\s*No\\.?|Item#|SKU)$"
      upc: "^(UPC|Barcode)$"
      transaction_date: "^(Transaction\\s*Date|Date|Trans\\s*Date|TransactionDate)$"
    normalization:
      trim_whitespace: true
      preserve_case: true
    skip_patterns:
      # Note: Do NOT add control keywords like "TOTAL", "TAX", "Total Items Sold" here
      # They are handled by CONTROL_PATTERNS in layout_applier.py
      - "BALANCE"
      - "PREVIOUS BALANCE"

  # Variant B: No qty/unit, still extract name + total
  - name: "RD Excel v_total_only"
    parsed_by: "rd_excel_v2"
    applies_to:
      vendor_code: ["RD", "RESTAURANT_DEPOT"]
      file_ext: [".xlsx", ".xls"]
      header_contains:
        - "Item Description"
        - "(?i)Extended\\s*Amount(?:\\s*\\(USD\\))?"
    required_columns:
      - "Item Description"
      - "Extended Amount (USD)"
    optional_columns:
      - "Item Number"
      - "UPC"
      - "Transaction Date"
    column_mappings:
      product_name: "Item Description"
      total_price: "(?i)Extended\\s*Amount(?:\\s*\\(USD\\))?|Total\\s*Price"
      item_number: "^(Item\\s*Number|Item\\s*#|Item\\s*No\\.?|Item#|SKU)$"
      upc: "^(UPC|Barcode)$"
      transaction_date: "^(Transaction\\s*Date|Date|Trans\\s*Date|TransactionDate)$"
    normalization:
      trim_whitespace: true
      preserve_case: true
    skip_patterns:
      # Note: Do NOT add control keywords like "TOTAL", "TAX", "Total Items Sold" here
      # They are handled by CONTROL_PATTERNS in layout_applier.py
      - "BALANCE"
      - "PREVIOUS BALANCE"

  # CSV variant: make it as tolerant as Excel
  - name: "RD CSV Report (Extended Format)"
    parsed_by: "rd_excel_v2_csv"
    applies_to:
      vendor_code: ["RD", "RESTAURANT_DEPOT"]
      file_ext: [".csv", ".CSV"]
      header_contains:
        - "Item Description"
        - "(?i)Extended\\s*Amount(?:\\s*\\(USD\\))?"
    required_columns:
      - "Item Description"
      - "Extended Amount (USD)"
    optional_columns:
      - "QTY"
      - "Unit Price"
      - "UPC"
      - "Item Number"
      - "Transaction Date"
    column_mappings:
      product_name: "Item Description"
      quantity: "^(QTY|Qty|Quantity)$"
      unit_price: "^(Unit\\s*Price|Price|UnitPrice)$"
      total_price: "(?i)Extended\\s*Amount(?:\\s*\\(USD\\))?|Total\\s*Price"
      upc: "^(UPC|Barcode)$"
      item_number: "^(Item\\s*Number|Item\\s*#|Item\\s*No\\.?|Item#|SKU)$"
      transaction_date: "^(Transaction\\s*Date|Date|Trans\\s*Date|TransactionDate)$"
    normalization:
      trim_whitespace: true
      preserve_case: true
    skip_patterns:
      # Note: Do NOT add control keywords like "TOTAL", "TAX", "Total Items Sold" here
      # They are handled by CONTROL_PATTERNS in layout_applier.py
      - "BALANCE"
      - "PREVIOUS BALANCE"
      - ""
      - "nan"
  
  # PDF variant: Grid mode (uses pdfplumber to extract tables, then applies same column mappings as Excel)
  - name: "RD PDF Grid v1"
    parsed_by: "rd_pdf_v1"
    applies_to:
      vendor_code: ["RD", "RESTAURANT_DEPOT"]
      file_ext: [".pdf"]
      header_contains:
        - "Item Description"
        - "(?i)Extended\\s*Amount(?:\\s*\\(USD\\))?"
      text_contains:
        - "Restaurant Depot"
        - "Item Description"
    required_columns:
      - "Item Description"
      - "(?i)Extended\\s*Amount(?:\\s*\\(USD\\))?"
    optional_columns:
      - "QTY"
      - "Unit Price"
      - "Item Number"
      - "UPC"
      - "Transaction Date"
    column_mappings:
      product_name: "Item Description"
      quantity: "^(QTY|Qty|Quantity)$"
      unit_price: "^(Unit\\s*Price|Price|UnitPrice|U\\s*Price)$"
      total_price: "(?i)Extended\\s*Amount(?:\\s*\\(USD\\))?|Total\\s*Price|Amount"
      item_number: "^(Item\\s*Number|Item\\s*#|Item\\s*No\\.?|Item#|SKU)$"
      upc: "^(UPC|Barcode)$"
      transaction_date: "^(Transaction\\s*Date|Date|Trans\\s*Date|TransactionDate)$"
    normalization:
      trim_whitespace: true
      preserve_case: true
    skip_patterns:
      # Note: Do NOT add control keywords like "TOTAL", "TAX", "Total Items Sold" here
      # They are handled by CONTROL_PATTERNS in layout_applier.py
      - "BALANCE"
      - "PREVIOUS BALANCE"
    # OCR-specific patterns for image-based PDFs (when pdfplumber table extraction fails)
    ocr_extraction:
      # Item line parsing pattern (for OCR text)
      # Note: Use single quotes for regex patterns to avoid YAML escaping issues
      item_pattern:
        regex: '^(\\d{10,13})\\s+(\\d{5,10})\\s+(.+?)\\s+(\\d+[.,]\\d{2})\\s+(\\d+(?:\\.\\d+)?)\\s+[Uu]\\s*\\(?[Tt]\\)?\\s+(\\d+[.,]\\d{2})\\s*[Tt]?.*$'
        description: "RD item line format: UPC ItemNumber Description UnitPrice Qty U(T) ExtAmount Tax"
        groups:
          - upc
          - item_number
          - product_name
          - unit_price
          - quantity
          - total_price
      # OCR error correction rules (applied before pattern matching)
      error_corrections:
        - find: ":"
          replace: "."
          description: "Fix '32:15' -> '32.15'"
        - find: "|"
          replace: " "
          description: "Remove pipe characters"
        - find: "(\\d)\\.([f])"
          replace: "\\1.7"
          description: "Fix '21.f2' -> '21.72'"
        - find: "(\\d)\\.([e])"
          replace: "\\1.2"
          description: "Fix '21.e2' -> '21.22'"
      # Totals extraction patterns (for OCR text)
      # Note: Use single quotes for regex patterns to avoid YAML escaping issues
      totals_patterns:
        subtotal:
          - regex: 'Subtotal[:\\s]+(?:\\$?\\s*)?([0-9,]+(?:\\.[0-9]{2})?)'
          - regex: 'Sub\\s+Total[:\\s]+(?:\\$?\\s*)?([0-9,]+(?:\\.[0-9]{2})?)'
          - regex: 'SUBTOTAL[:\\s]+(?:\\$?\\s*)?([0-9,]+(?:\\.[0-9]{2})?)'
        tax:
          - regex: 'Taxes?[:\\s]+(?:\\$?\\s*)?([0-9,]+(?:\\.[0-9]{2})?)'
          - regex: 'Tax[:\\s]+(?:\\$?\\s*)?([0-9,]+(?:\\.[0-9]{2})?)'
          - regex: 'Sales\\s+Tax[:\\s]+(?:\\$?\\s*)?([0-9,]+(?:\\.[0-9]{2})?)'
          - regex: 'IL\\s+FOOD\\s+Tax[:\\s]+(?:\\$?\\s*)?([0-9,]+(?:\\.[0-9]{2})?)'
          - regex: 'TOTAL\\s+TAX[:\\s]+(?:\\$?\\s*)?([0-9,]+(?:\\.[0-9]{2})?)'
        total:
          - regex: 'TRANSACTION\\s+TOTAL[:\\s]+(?:\\$?\\s*)?([0-9,]+(?:\\.[0-9]{2})?)'
          - regex: 'Total[:\\s]+(?:\\$?\\s*)?([0-9,]+(?:\\.[0-9]{2})?)'
          - regex: 'Grand\\s+Total[:\\s]+(?:\\$?\\s*)?([0-9,]+(?:\\.[0-9]{2})?)'
      # Skip patterns for OCR text (non-item lines)
      skip_lines:
        - "BALANCE"
        - "PREVIOUS BALANCE"
        - "RESTAURANT DEPOT"
        - "JETRO CASH"
        - "^\\|"
        - "^:"
      # Stop patterns (end of item section)
      stop_patterns:
        - "SUBTOTAL"
        - "TAX"
        - "TOTAL"
        - "TRANSACTION TOTAL"
