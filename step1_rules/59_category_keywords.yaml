# Global Category Keywords and Pipeline Settings
# Keyword rules and heuristics that apply across all sources

category_keywords:
  description: >
    Global keyword matching rules and heuristic classifiers.
    Applied after source-specific mappings but before fallback.
  
  # Pipeline execution order
  pipeline_order:
    - source_map        # Source-specific rules (Instacart/Amazon)
    - vendor_overrides  # Vendor-specific hints from L2 catalog
    - keywords          # Global keyword rules (this file)
    - heuristics        # Smart classifiers (fruit/packaging/topping)
    - overrides         # Tax/discount/shipping overrides (from L1)
    - fallback          # C99 Unknown
  
  # Global keyword rules (ordered by priority)
  keyword_rules:
    # Packaging
    - include_regex: '(?i)\b(cup|cups|tumbler)\b'
      map_to_l2: C20
      priority: 90
      hints: ['Cups & Lids']
    
    - include_regex: '(?i)\b(lid|lids|cover)\b'
      map_to_l2: C20
      priority: 90
      hints: ['Cups & Lids']
    
    - include_regex: '(?i)\b(straw|straws)\b'
      map_to_l2: C22
      priority: 90
      hints: ['Utensils & Misc Packaging - Straws']
    
    - include_regex: '(?i)\b(bag|bags|tote)\b'
      exclude_regex: '(?i)\b(tea bag|trash bag|garbage bag|checkout bag|carrier bag|bag fee)\b'
      map_to_l2: C21
      priority: 85
      hints: ['Bags & Trays - Exclude tea bags, trash bags, and checkout bag fees (those are service fees)']
    
    - include_regex: '(?i)(aluminum\s+tray|food\s+tray|serving\s+tray)'
      map_to_l2: C21
      priority: 90
      hints: ['Bags & Trays - BBI "Aluminum Tray No Charge"']
    
    - include_regex: '(?i)(chopsticks|utensil|fork|spoon|knife)'
      map_to_l2: C22
      priority: 90
      hints: ['Utensils & Misc Packaging - BBI "Chopsticks No Charge"']
    
    - include_regex: '(?i)\b(skewer|skewers|bamboo skewer)\b'
      map_to_l2: C22
      priority: 90
      hints: ['Utensils & Misc Packaging - Skewers (e.g., "EEcoChoice Compostable 6" Round Bamboo Skewer")']
    
    - include_regex: '(?i)\b(label|labels|sticker|stickers)\b'
      map_to_l2: C23
      priority: 90
      hints: ['Labels & Stickers']

    # POS paper vs service paper distinction
    - include_regex: '(?i)\b(thermal\s+paper|receipt\s+paper|register\s+tape|cash\s+register\s+tape|pos\s+paper|receipt\s+roll|pos\s+roll)\b'
      map_to_l2: C61
      priority: 92
      hints: ['POS Paper & Register Supplies']
    
    - include_regex: '(?i)(décor\s+paper|decorative\s+paper|packing\s+paper)'
      map_to_l2: C22
      priority: 85
      hints: ['Utensils & Misc Packaging - BBI "Uni Décor Paper" for packing']
    
    # Uniforms & Apparel (Non-COGS)
    - include_regex: '(?i)\b(uni\s+cap|uni\s+hoodie|uniform|cap|hoodie|apron|shirt)\b'
      map_to_l2: C60
      priority: 90
      hints: ['Office/Admin - BBI "Uni Cap", "Uni Hoodie" (uniform expenses)']
    
    # Tea & Coffee
    - include_regex: '(?i)\b(tea|green tea|black tea|oolong|matcha|chai)\b'
      map_to_l2: C01
      priority: 90
      hints: ['Tea & Coffee']
    
    - include_regex: '(?i)\b(coffee|espresso|beans|ground coffee)\b'
      map_to_l2: C01
      priority: 90
      hints: ['Tea & Coffee']
    
    # Syrups
    - include_regex: '(?i)\b(syrup|syrups|torani|monin)\b'
      map_to_l2: C02
      priority: 90
      hints: ['Syrups']
    
    # Jams & Preserves
    - include_regex: '(?i)^Jam\b.*\b(passion|mango|strawberry|peach|fruit)'
      map_to_l2: C03
      priority: 95
      hints: ['Jam/Purée - BBI "Jam Passion fruit", "Jam Mango"']
    
    # Toppings & Mochi
    - include_regex: '(?i)\b(tapioca|boba|pearl|popping|crystal)\b'
      map_to_l2: C08
      priority: 95
      hints: ['Toppings & Jellies']
    
    - include_regex: '(?i)\b(lychee jelly|grass jelly|coconut jelly|aloe)\b'
      map_to_l2: C08
      priority: 95
      hints: ['Toppings & Jellies']
    
    - include_regex: '(?i)(powder\s+mochi|mochi\s+powder|mochi\b)'
      map_to_l2: C08
      priority: 90
      hints: ['Toppings & Jellies - BBI "Powder Mochi"']
    
    # Taro & Sweet Ingredients
    - include_regex: '(?i)\b(taro|ube)\b'
      map_to_l2: C08
      priority: 85
      hints: ['Toppings & Jellies - BBI "Can Taro Mocha"']
    
    # Dairy
    - include_regex: '(?i)\b(milk|whole milk|skim|2%|oat milk|almond milk)\b'
      map_to_l2: C04
      priority: 85
      hints: ['Dairy & Milk']
    
    - include_regex: '(?i)\b(cream|creamer|half-and-half|half & half|heavy whip|whipping cream)\b'
      map_to_l2: C04
      priority: 85
      hints: ['Dairy & Milk - Including heavy cream/whipping cream (Aldi "Heavy Whip")']

    - include_regex: '(?i)\b(yogurt|greek yogurt)\b'
      map_to_l2: C04
      priority: 90
      hints: ['Dairy & Milk - Yogurt products']
    
    # Sweeteners & Sugar
    - include_regex: '(?i)\b(sugar|granulated sugar|cane sugar|brown sugar)\b'
      map_to_l2: C05
      priority: 90
      hints: ['Sweeteners/Sugar - Including "Sugar Granulated"']
    
    - include_regex: '(?i)\b(honey|agave|stevia|sweetener)\b'
      map_to_l2: C05
      priority: 85
      hints: ['Sweeteners/Sugar']
    
    # Fruit cups in syrup → Syrups & Sauces (per user)
    - include_regex: '(?i)\b(fruit\s+cup|grapefruit)\b.*\b(in\s+extra\s+light\s+syrup|in\s+syrup|light\s+syrup)\b'
      map_to_l2: C02
      priority: 92
      hints: ['Syrups & Sauces - Canned fruit cups in (extra light) syrup']

    # Fresh Fruit - Grapefruit
    - include_regex: '(?i)\b(grapefruit|grapefruits)\b'
      map_to_l2: C09
      priority: 85
      hints: ['Fresh Fruit - Grapefruit']

    # Grains & Starches
    - include_regex: '(?i)\b(panko|breadcrumb|bread crumb|coating)\b'
      map_to_l2: C07
      priority: 90
      hints: ['Grains & Starches - Panko, breadcrumbs, coatings (RD)']
    
    - include_regex: '(?i)(powder\s+.*\s+starch|starch\s+powder|potato\s+starch|corn\s+starch|tapioca\s+starch)'
      map_to_l2: C07
      priority: 90
      hints: ['Grains & Starches - BBI "Powder Sweet Potato Starch"']
    
    # Seasonings & Marinades
    - include_regex: '(?i)(marinade|seasoning|spice|powder.*marinade)'
      map_to_l2: C03
      priority: 90
      hints: ['Jam/Purée/Sauce - BBI "Powder Chicken Marinade" (seasonings)']
    
    # Cheese Products
    - include_regex: '(?i)(cheese\s+powder|powder\s+cheese|cheese\s+float)'
      map_to_l2: C06
      priority: 90
      hints: ['Creamer & Powders - BBI "Powder Cheese Float"']
    
    # Frozen Snacks / Appetizers (RD-specific)
    - include_regex: '(?i)(MOZZ\s+STX|MOZZARELLA\s+STICK|CHEESE\s+STICK)'
      map_to_l2: C33
      priority: 95
      hints: ['Retail Snacks & Beverages - Frozen appetizers like mozzarella sticks']
    
    # Protein / Meat (RD-specific patterns)
    - include_regex: '(?i)(^CHX\b|^CHIX\b|NUGGET|BREAST|WING|THIGH|DRUMSTICK)'
      map_to_l2: C14
      priority: 90
      hints: ['Meat & Seafood - Chicken products (RD abbreviations)']
    
    # French Fries / Frozen Potatoes (RD-specific)
    - include_regex: '(?i)(^FF\b|CRINKL|STRGHT|WAFFLE FRIES|TWISTER|TATER)'
      map_to_l2: C13
      priority: 95
      hints: ['Frozen Vegetables - French fries and potato products (RD)']
    
    # Oils (RD-specific)
    - include_regex: '(?i)(^OIL\b|SHRT.*CRM|SHORTENING|VEGETABLE OIL)'
      map_to_l2: C15
      priority: 90
      hints: ['Other Ingredients - Oils and shortening (RD)']
    
    # Fresh Vegetables (Parktoshop and others)
    - include_regex: '(?i)\b(green onion|scallion|onion|basil|cilantro|parsley|herb|lettuce|spinach|kale)\b'
      map_to_l2: C12
      priority: 85
      hints: ['Fresh Vegetables - Including herbs (Parktoshop "GREEN ONION", "BASIL LEAVE")']
    
    # Cleaning & Chemicals (including WebstaurantStore products)
    - include_regex: '(?i)\b(cleaner|detergent|sanitizer|disinfectant|chlorine|test strip|sani)\b'
      map_to_l2: C50
      priority: 85
      hints: ['Cleaning & Chemicals - Sanitizers, disinfectants, test strips (WebstaurantStore)']
    
    # Body Fluid Spill Kits (WebstaurantStore)
    - include_regex: '(?i)\b(spill kit|body fluid|clamshell case)\b'
      map_to_l2: C31
      priority: 90
      hints: ['Gloves & Food Service Supplies - Spill kits (WebstaurantStore)']
    
    - include_regex: '(?i)\b(trash bag|garbage bag)\b'
      map_to_l2: C50
      priority: 90
      hints: ['Cleaning & Chemicals - Trash bags']
    
    # Smallwares & Equipment
    - include_regex: '(?i)\b(tent|canopy|pop up canopy|straight leg canopy)\b'
      map_to_l2: C40
      priority: 90
      hints: ['Smallwares & Equipment - Tents and canopies (e.g., Galaxy Equipment 10x10 White Straight Leg Instant Pop Up Canopy Tent)']
    
    - include_regex: '(?i)\b(straw\s+holder|stirrers?\s+holder|stirrer\s+holder|utensil\s+holder|organizer|caddy|rack)\b'
      map_to_l2: C40
      priority: 88
      hints: ['Smallwares & Equipment - Holders/organizers/caddies/racks for kitchen tools']
    
    # Explicit IQF strawberry mapping
    - include_regex: '(?i)\bIQF\b.*\bstrawberr(y|ies)\b|\bstrawberr(y|ies)\b.*\bIQF\b'
      map_to_l2: C10
      priority: 96
      hints: ['Frozen Fruit - IQF strawberries']
  
  # Vendor-specific abbreviations and normalizations
  vendor_abbreviations:
    costco:
      description: >
        Costco uses abbreviated product names. Map common abbreviations to full names.
      organic_markers:
        - 'ORG\b'           # ORG = Organic (word boundary to avoid matching ORGANIZE, etc.)
        - '\bORGANIC\b'
      fruit_abbreviations:
        STRAWBRY: 'Strawberry'
        GRPS: 'Grapes'
        BLUBRY: 'Blueberry'
        RASBRY: 'Raspberry'
      vegetable_abbreviations:
        TOMS: 'Tomatoes'
        CUKES: 'Cucumbers'
        BROCLI: 'Broccoli'
      notes:
        - Pattern matching should be case-insensitive
        - 'Example: "ORG STRAWBRY" maps to Organic Strawberry'
        - 'Example: "ORG GRN GRPS" maps to Organic Green Grapes'
    
    restaurant_depot:
      description: >
        Restaurant Depot (RD) uses heavy abbreviations for product names.
        These patterns help classify items even with abbreviated names.
      
      # Prefix patterns for classification (not full expansion)
      protein_prefixes:
        - 'CHX\b'           # Chicken
        - 'CHIX\b'          # Chicken (alternate)
        - 'BF\b'            # Beef
        - 'BEEF\b'
        - 'PORK\b'
        - 'FISH\b'
        - 'SALMN\b'         # Salmon
        - 'SHRIMP\b'
        - 'SHRMP\b'
      
      frozen_prefixes:
        - '^FZ\b'           # Frozen (start of line)
        - '\bFROZ\b'
        - '\bFRZN\b'
      
      fries_patterns:
        - '^FF\b'           # French Fries
        - 'CRINKL'          # Crinkle
        - 'STRGHT'          # Straight cut
        - 'WAFFLE'          # Waffle fries
        - 'TWISTER'         # Twister fries
        - 'TATER'           # Tater tots
      
      oil_patterns:
        - '^OIL\b'          # Oil (start of line)
        - 'SHRT'            # Shortening
        - 'VEG\b'           # Vegetable
        - 'OLIVE\b'
        - 'CANOLA\b'
      
      dairy_patterns:
        - 'CREAM\b'
        - 'MILK\b'
        - 'BUTTER\b'
        - 'CHEESE\b'
        - 'CHDR\b'          # Cheddar
      
      frozen_snack_patterns:
        - 'MOZZ\s+STX'      # Mozzarella Sticks
        - 'CHEESE\s+STX'    # Cheese Sticks
      
      coating_patterns:
        - 'PANKO\b'         # Panko breadcrumbs
        - 'BREADCRUMB'
        - 'COATING'
      
      descriptor_abbreviations:
        BNLS: 'Boneless'
        SKLS: 'Skinless'
        BTRD: 'Battered'
        BRDD: 'Breaded'
        IQF: 'Individually Quick Frozen'
        UHT: 'Ultra Heat Treated'
      
      notes:
        - 'Pattern matching is case-insensitive'
        - 'Use these patterns for CLASSIFICATION, not full expansion'
        - 'Full product details should come from knowledge base'
        - 'Example: "CHX NUGGET BTRD TY" → Classify as Meat/Seafood (C14)'
        - 'Example: "FF CRINKL 6/5LB" → Classify as Frozen Vegetables (C13)'
        - 'Example: "OIL SHRT CRM" → Classify as Other Ingredients (C15)'
        - 'Example: "FZ MOZZ STX IT BRD" → Classify as Retail Snacks (C33)'
        - 'Example: "PANKO PLAIN CQ" → Classify as Grains & Starches (C07)'
        - 'Example: "CREAM JF 36% UHT" → Classify as Dairy & Milk (C04)'
    
    bbi:
      description: >
        BBI (bubble tea ingredient supplier) uses descriptive product names with prefixes.
        These patterns help classify bubble tea ingredients and related products.
      
      prefix_patterns:
        - 'Powder\b'      # Various powders (marinade, starch, cheese, mochi)
        - 'Jam\b'         # Fruit jams
        - 'Can\b'         # Canned products
        - 'Uni\b'         # Uniform items
      
      product_categories:
        marinades: ['Powder Chicken Marinade', 'Powder Beef Marinade']
        starches: ['Powder Sweet Potato Starch', 'Tapioca Starch']
        jams: ['Jam Passion fruit', 'Jam Mango', 'Jam Strawberry']
        cheese_products: ['Powder Cheese Float']
        toppings: ['Powder Mochi', 'Can Taro Mocha']
        uniforms: ['Uni Cap', 'Uni Hoodie']
        packaging: ['Uni Décor Paper', 'Aluminum Tray', 'Chopsticks']
      
      notes:
        - '"No Charge" should be filtered from product names (see text cleaning rules)'
        - 'Pattern matching is case-insensitive'
        - 'Example: "Powder Chicken Marinade" → C03 Jam/Purée/Sauce (seasonings)'
        - 'Example: "Powder Sweet Potato Starch" → C07 Grains & Starches'
        - 'Example: "Jam Passion fruit" → C03 Jam/Purée'
        - 'Example: "Powder Mochi" → C08 Toppings & Jellies'
        - 'Example: "Can Taro Mocha" → C08 Toppings & Jellies'
        - 'Example: "Uni Cap" → C60 Office/Admin (uniform)'
        - 'Example: "Aluminum Tray No Charge" → C21 Bags & Trays'
  
  # Heuristic classifiers (smart pattern detection)
  heuristics:
    # Fruit classifier
    fruit:
      description: >
        Detects fruit items and classifies as Fresh/Frozen based on context.
        Includes Costco abbreviations (STRAWBRY, GRPS).
        Excludes items with "powder", "jelly", "jam", "purée", "topping" to avoid false positives.
      tokens:
        - apple
        - banana
        - strawberry
        - strawberries
        - strawbry          # Costco abbreviation
        - blueberry
        - blueberries
        - raspberry
        - raspberries
        - blackberry
        - blackberries
        - mango
        - pineapple
        - orange
        - grape
        - grapes
        - grps              # Costco abbreviation for grapes
        - peach
        - pear
        - plum
        - lemon
        - lime
        - kiwi
        - melon
        - watermelon
        - cantaloupe
      unless_name_matches:
        - "(?i)\\bpowder\\b"
        - "(?i)\\b(jelly|jam|pur[ée]e|topping)\\b"
      freezer_markers:
        - frozen
        - freeze-dried
        - freeze dried
        - '°F'
        - '-°F'
        - iqf
      map_to_l2_fresh: C09   # Fresh Fruit
      map_to_l2_frozen: C10  # Frozen Fruit
      confidence: 0.85
    
    # Packaging classifier
    packaging:
      description: >
        Detects packaging materials based on common keywords.
      tokens:
        - cup
        - lid
        - straw
        - sleeve
        - bag
        - tray
        - box
        - container
        - utensil
        - fork
        - spoon
        - knife
        - stirrer
        - napkin
        - label
        - sticker
      map_to_l2: C20  # Default to Cups & Lids (refined by other rules)
      confidence: 0.80
    
    # Topping classifier
    topping:
      description: >
        Detects bubble tea toppings and add-ins.
      tokens:
        - tapioca
        - boba
        - pearl
        - jelly
        - popping
        - crystal
        - lychee
        - grass
        - coconut jelly
        - aloe
      map_to_l2: C08  # Toppings & Jellies
      confidence: 0.90
    
    # Dairy classifier
    dairy:
      description: >
        Detects dairy and milk products.
      tokens:
        - milk
        - cream
        - half-and-half
        - half & half
        - dairy
        - creamer
      map_to_l2: C04  # Dairy & Milk
      confidence: 0.85
    
    # Cleaning classifier
    cleaning:
      description: >
        Detects cleaning and janitorial supplies.
      tokens:
        - clean
        - detergent
        - sanitizer
        - disinfectant
        - bleach
        - mop
        - broom
        - brush
        - trash
        - garbage
      map_to_l2: C50  # Cleaning & Chemicals
      confidence: 0.80
  
  # Fallback settings
  fallback_l2: C99  # Unknown category
  
  # Default confidence by stage
  default_confidence:
    source_map: 0.95       # High confidence for source-specific rules
    vendor_overrides: 0.90  # High confidence for vendor hints
    keywords: 0.80          # Medium-high for keyword matches
    heuristics: 0.70        # Medium for smart classifiers
    overrides: 1.00         # Absolute confidence for tax/discount/shipping
    fallback: 0.20          # Low confidence for unmapped items
  
  # Review threshold
  review_threshold: 0.60  # Items below this confidence need review

notes:
  - keyword_rules are evaluated in priority order
  - exclude_regex can be used to filter out false positives
  - heuristics provide smart classification based on multiple tokens
  - fruit heuristic checks for freezer_markers to distinguish Fresh vs Frozen
  - All patterns are case-insensitive
  - Confidence scores help identify items needing manual review

