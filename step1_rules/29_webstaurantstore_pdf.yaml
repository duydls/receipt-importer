# WebstaurantStore PDF Layout Rules
# WebstaurantStore provides restaurant supplies and equipment
# Format: PDF invoices with tabular item data

webstaurantstore_pdf:
  description: >
    WebstaurantStore PDF invoice parsing rules.
    PDF contains order header, item table, and totals.
    Items have: Item Number, Description, Unit Price, QTY, Est. Tax, Total
  
  layouts:
    - name: webstaurantstore_invoice_v1
      applies_to:
        vendor_code: WEBSTAURANTSTORE
        content_contains:
          - "WebstaurantStore"
          - "Sales Invoice"
          - "Order Number"
      
      # Text extraction patterns for PDF
      text_patterns:
        # Order metadata
        order_number:
          pattern: 'Order Number.*?(\d+)'
          group: 1
          field: receipt_number
        
        order_date:
          pattern: 'Date Ordered\s+(\d+/\d+/\d{4})'
          group: 1
          field: transaction_date
        
        user_id:
          pattern: 'User ID\s+(\d+)'
          group: 1
          field: user_id
        
        # Billing/shipping info
        bill_to:
          pattern: 'Bill To\s+(.*?)(?:Ship To|Shipping Method)'
          group: 1
          field: bill_to
          multiline: true
        
        ship_to:
          pattern: 'Ship To\s+(.*?)(?:Shipping Method|Your Contact)'
          group: 1
          field: ship_to
          multiline: true
        
        # Payment
        payment_method:
          pattern: 'Payment Method:\s+(.*?)\s+-\s+XXXX(\d+)\s+-\s+\$([0-9,]+\.\d{2})'
          groups: [1, 2, 3]
          fields: [payment_type, card_last4, payment_amount]
        
        # Totals
        subtotal:
          pattern: 'Subtotal:\$([0-9,]+\.\d{2})'
          group: 1
          field: subtotal
        
        shipping:
          pattern: 'Shipping & Handling:\$([0-9,]+\.\d{2})'
          group: 1
          field: shipping
        
        tax:
          pattern: 'Es[tm]ated Tax:\$([0-9,]+\.\d{2})'
          group: 1
          field: tax
        
        total:
          pattern: 'Total:\$([0-9,]+\.\d{2})'
          group: 1
          field: total
        
        balance_due:
          pattern: 'Balance Due:\$([0-9,]+\.\d{2})'
          group: 1
          field: balance_due
      
      # Item extraction from table
      item_table_pattern:
        # Items appear between header and "Subtotal:"
        # Format: Item Number | Description | Unit Price | QTY | Est. Tax | Total
        table_start_marker: "Item Number.*?Descrip[tion]+"
        table_end_marker: "Subtotal:"
        
        item_line_pattern: >
          (\S+)\s+                          # Item Number (e.g., 373CH1000)
          (.*?)                              # Description (multiline allowed)
          \$([0-9,]+\.\d{2})\s+             # Unit Price
          (\d+)\s+                           # Quantity
          \$([0-9,]+\.\d{2})\s+             # Est. Tax
          \$([0-9,]+\.\d{2})                # Total
        
        item_fields:
          - field: item_number
            group: 1
            type: string
          - field: product_name
            group: 2
            type: string
            clean: true  # Remove extra whitespace, newlines
          - field: unit_price
            group: 3
            type: float
          - field: quantity
            group: 4
            type: float
          - field: item_tax
            group: 5
            type: float
          - field: total_price
            group: 6
            type: float
      
      # UoM extraction from description
      uom_extraction:
        enabled: true
        patterns:
          # WebstaurantStore often includes pack size in description
          - pattern: '(\d+)/Pack'
            format: '{0}-pk'
          - pattern: '(\d+)/Case'
            format: '{0}-cs'
          - pattern: '(\d+)/Box'
            format: '{0}-bx'
          - pattern: '(\d+)\s*Pack'
            format: '{0}-pk'
          - pattern: '(\d+)\s*(?:oz|OZ)'
            format: '{0}-oz'
          - pattern: '(\d+)\s*(?:lb|LB|Lb)'
            format: '{0}-lb'
          - pattern: '(\d+)\s*(?:gal|GAL|gallon)'
            format: '{0}-gal'
      
      # Data cleaning
      cleaning_rules:
        product_name:
          - remove_extra_whitespace: true
          - remove_newlines: true
          - trim: true
        
        item_number:
          - uppercase: false
          - trim: true
      
      # Validation rules
      validation:
        required_fields:
          - order_number
          - order_date
          - total
        
        numeric_fields:
          - subtotal
          - shipping
          - tax
          - total
          - unit_price
          - quantity
          - total_price
        
        total_validation:
          # Verify: sum(item totals) + shipping = subtotal + tax + shipping = total
          check_item_sum: true
          check_grand_total: true
          tolerance: 0.02  # Allow 2 cent difference for rounding
      
      # Review triggers
      needs_review_if:
        - condition: "no_items_extracted"
          reason: "No items found in PDF"
        - condition: "total_mismatch"
          reason: "Item totals don't match grand total"
        - condition: "missing_required_field"
          reason: "Missing order number, date, or total"
      
      # Category hints (for classification stage)
      category_hints:
        default_l2: C40  # Smallwares & Equipment (restaurant supplies)
        keywords:
          - keyword: "sanitizer"
            l2: C50  # Cleaning & Chemicals
          - keyword: "chlorine"
            l2: C50  # Cleaning & Chemicals
          - keyword: "test strip"
            l2: C50  # Cleaning & Chemicals
          - keyword: "glove"
            l2: C31  # Gloves & Food Service Supplies
          - keyword: "apron"
            l2: C60  # Office/Admin (uniforms)
          - keyword: "thermometer"
            l2: C40  # Smallwares & Equipment
          - keyword: "container"
            l2: C40  # Smallwares & Equipment
          - keyword: "wrap"
            l2: C32  # Filters & Disposables
          - keyword: "foil"
            l2: C32  # Filters & Disposables
          - keyword: "towel"
            l2: C30  # Napkins & Paper Products
          - keyword: "napkin"
            l2: C30  # Napkins & Paper Products
          - keyword: "cup"
            l2: C20  # Cups & Lids
          - keyword: "lid"
            l2: C20  # Cups & Lids
          - keyword: "straw"
            l2: C22  # Utensils & Misc Packaging
          - keyword: "utensil"
            l2: C22  # Utensils & Misc Packaging
          - keyword: "bag"
            l2: C21  # Bags & Trays
          - keyword: "tray"
            l2: C21  # Bags & Trays

notes:
  - WebstaurantStore is a restaurant supply vendor
  - Items are typically equipment, smallwares, cleaning supplies, and disposables
  - NOT food ingredients (different from grocery vendors)
  - PDF format is consistent and well-structured
  - Item numbers are alphanumeric codes (e.g., 373CH1000, 381384101CLM)
  - Descriptions may span multiple lines in PDF
  - Tax is estimated at time of order (actual may vary)
  - Payment method is shown with last 4 digits of card

